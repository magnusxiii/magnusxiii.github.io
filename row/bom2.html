<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM Manager Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #1a1d29;
            --bg-card: #20253a;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #2d3548;
        }

        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 0;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1::before {
            content: 'âš¡';
            font-size: 2rem;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-toggle, .persist-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover, .persist-toggle:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .persist-toggle.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: var(--accent);
        }

        .card-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .required {
            color: var(--danger);
        }

        .project-name-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 2px dashed var(--accent);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .project-name-section .form-group input {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 14px;
            border: 2px solid var(--accent);
        }

        .project-name-section .form-group input:focus {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        }

        .project-name-section label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-name-section label::before {
            content: 'ğŸ·ï¸';
            font-size: 1.3rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-delete {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-email {
            background: linear-gradient(135deg, #ea4335 0%, #4285f4 100%);
            color: white;
        }

        .btn-email:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(234, 67, 53, 0.4);
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .stat-card p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border);
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-smd {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .badge-pth {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .badge-edge {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .badge-press-fit {
            background: rgba(236, 72, 153, 0.15);
            color: #ec4899;
        }

        .badge-cable {
            background: rgba(251, 146, 60, 0.15);
            color: #fb923c;
        }

        .badge-mechanical {
            background: rgba(148, 163, 184, 0.15);
            color: #94a3b8;
        }

        .badge-module {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        #xmlFileInput {
            display: none;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .modal-content {
            margin-bottom: 24px;
        }

        .orientation-option, .format-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .orientation-option:hover, .format-option:hover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        .orientation-option input[type="radio"],
        .format-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .orientation-label, .format-label {
            flex: 1;
        }

        .orientation-label strong, .format-label strong {
            display: block;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .orientation-label span, .format-label span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .orientation-icon, .format-icon {
            font-size: 2rem;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .email-input-group {
            margin-bottom: 20px;
        }

        .email-input-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .email-input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        @media (max-width: 768px) {
            .container { padding: 12px; }
            .header { flex-direction: column; gap: 16px; text-align: center; }
            .header-controls { flex-direction: column; width: 100%; }
            .theme-toggle, .persist-toggle { width: 100%; justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            .button-group { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            th, td { padding: 8px; font-size: 0.8rem; }
            .modal { padding: 24px; }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }
    </style>
</head>
<body>
    <!-- PDF Modal -->
    <div class="modal-overlay" id="pdfModal">
        <div class="modal">
            <div class="modal-header">ğŸ“„ Î•Ï€Î¹Î»Î¿Î³Î® Î ÏÎ¿ÏƒÎ±Î½Î±Ï„Î¿Î»Î¹ÏƒÎ¼Î¿Ï PDF</div>
            <div class="modal-content">
                <label class="orientation-option">
                    <input type="radio" name="orientation" value="portrait" checked>
                    <div class="orientation-label">
                        <strong>Portrait (ÎšÎ¬Î¸ÎµÏ„Î¿)</strong>
                        <span>Î“Î¹Î± Î»Î¯ÏƒÏ„ÎµÏ‚ Î¼Îµ Î»Î¯Î³ÎµÏ‚ ÏƒÏ„Î®Î»ÎµÏ‚</span>
                    </div>
                    <div class="orientation-icon">ğŸ“„</div>
                </label>
                <label class="orientation-option">
                    <input type="radio" name="orientation" value="landscape">
                    <div class="orientation-label">
                        <strong>Landscape (ÎŸÏÎ¹Î¶ÏŒÎ½Ï„Î¹Î¿)</strong>
                        <span>Î ÏÎ¿Ï„ÎµÎ¯Î½ÎµÏ„Î±Î¹ - Î ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ ÏƒÏ„Î®Î»ÎµÏ‚</span>
                    </div>
                    <div class="orientation-icon">ğŸ“ƒ</div>
                </label>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePDFModal()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
                <button class="btn btn-success" onclick="confirmPDFExport()">ğŸ“• Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF</button>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal">
            <div class="modal-header">ğŸ“§ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¼Î­ÏƒÏ‰ Email</div>
            <div class="modal-content">
                <div class="email-input-group">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500;">Email Î Î±ÏÎ±Î»Î®Ï€Ï„Î·:</label>
                    <input type="email" id="recipientEmail" placeholder="example@email.com">
                </div>

                <label style="display: block; margin-bottom: 12px; color: var(--text-secondary); font-weight: 500;">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Format:</label>
                
                <label class="format-option">
                    <input type="radio" name="emailFormat" value="xlsx" checked>
                    <div class="format-label">
                        <strong>Excel (XLSX)</strong>
                        <span>Î“Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÏƒÎµ Excel/Sheets</span>
                    </div>
                    <div class="format-icon">ğŸ“Š</div>
                </label>

                <label class="format-option">
                    <input type="radio" name="emailFormat" value="csv">
                    <div class="format-label">
                        <strong>CSV</strong>
                        <span>Î£Ï…Î¼Î²Î±Ï„ÏŒ Î¼Îµ ÏŒÎ»Î± Ï„Î± Ï€ÏÎ¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î±</span>
                    </div>
                    <div class="format-icon">ğŸ“„</div>
                </label>

                <label class="format-option">
                    <input type="radio" name="emailFormat" value="xml">
                    <div class="format-label">
                        <strong>XML</strong>
                        <span>Î”Î¿Î¼Î·Î¼Î­Î½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±</span>
                    </div>
                    <div class="format-icon">ğŸ”–</div>
                </label>

                <label class="format-option">
                    <input type="radio" name="emailFormat" value="pdf">
                    <div class="format-label">
                        <strong>PDF</strong>
                        <span>Î“Î¹Î± ÎµÎºÏ„ÏÏ€Ï‰ÏƒÎ· ÎºÎ±Î¹ Ï€ÏÎ¿Î²Î¿Î»Î®</span>
                    </div>
                    <div class="format-icon">ğŸ“•</div>
                </label>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEmailModal()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
                <button class="btn btn-success" onclick="confirmEmailSend()">ğŸ“§ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>BOM Manager Pro</h1>
            <div class="header-controls">
                <button class="persist-toggle active" id="persistToggle" onclick="togglePersistence()">
                    <span id="persistIcon">ğŸ’¾</span>
                    <span id="persistText">Auto-Save</span>
                </button>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">ğŸŒ™</span>
                    <span id="themeText">Dark</span>
                </button>
            </div>
        </div>

        <div class="project-name-section">
            <div class="form-group">
                <label>Project Name (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
                <input type="text" id="projectName" placeholder="Ï€.Ï‡. ESP32 Development Board, Arduino Shield, Power Supply">
            </div>
        </div>

        <div class="card">
            <div class="card-header">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Component</div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Designator <span class="required">*</span></label>
                    <input type="text" id="designator" placeholder="R1, C5, IC1">
                </div>
                <div class="form-group">
                    <label>Value <span class="required">*</span></label>
                    <input type="text" id="value" placeholder="10kÎ©, 100nF">
                </div>
                <div class="form-group">
                    <label>Î Î¿ÏƒÏŒÏ„Î·Ï„Î± <span class="required">*</span></label>
                    <input type="number" id="quantity" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>Î¤ÏÏ€Î¿Ï‚ <span class="required">*</span></label>
                    <select id="type">
                        <option value="">Î•Ï€Î¹Î»Î¿Î³Î®</option>
                        <option value="SMD">SMD</option>
                        <option value="PTH">PTH</option>
                        <option value="Edge">Edge</option>
                        <option value="Press-Fit">Press-Fit</option>
                        <option value="Cable">Cable</option>
                        <option value="Mechanical">Mechanical</option>
                        <option value="Module">Module</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Package</label>
                    <input type="text" id="package" placeholder="0805, DIP-8">
                </div>
                <div class="form-group">
                    <label>ÎšÎ±Ï„Î±ÏƒÎºÎµÏ…Î±ÏƒÏ„Î®Ï‚</label>
                    <input type="text" id="manufacturer" placeholder="Texas Instruments">
                </div>
                <div class="form-group">
                    <label>MPN</label>
                    <input type="text" id="mpn" placeholder="LM358P">
                </div>
                <div class="form-group">
                    <label>Î ÏÎ¿Î¼Î·Î¸ÎµÏ…Ï„Î®Ï‚</label>
                    <input type="text" id="supplier" placeholder="Mouser, DigiKey">
                </div>
                <div class="form-group">
                    <label>SKU</label>
                    <input type="text" id="sku" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚">
                </div>
                <div class="form-group">
                    <label>Î¤Î¹Î¼Î® (â‚¬)</label>
                    <input type="number" id="price" step="0.001" min="0" placeholder="0.000">
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</label>
                <textarea id="description" placeholder="Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="addComponent()">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
                <button class="btn btn-secondary" onclick="clearForm()">ğŸ”„ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalComponents">0</h3>
                <p>Components</p>
            </div>
            <div class="stat-card">
                <h3 id="totalQuantity">0</h3>
                <p>Î¤ÎµÎ¼Î¬Ï‡Î¹Î±</p>
            </div>
            <div class="stat-card">
                <h3 id="totalCost">0.00â‚¬</h3>
                <p>ÎšÏŒÏƒÏ„Î¿Ï‚</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ“Š Î›Î¯ÏƒÏ„Î± Î¥Î»Î¹ÎºÏÎ½</div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Designator</th>
                            <th>Value</th>
                            <th>Qty</th>
                            <th>Type</th>
                            <th>Package</th>
                            <th>Manufacturer</th>
                            <th>MPN</th>
                            <th>Supplier</th>
                            <th>SKU</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Notes</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="bomTableBody">
                        <tr>
                            <td colspan="14" class="empty-state">
                                <div class="empty-state-icon">ğŸ“‹</div>
                                <div>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ components</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ“¤ Î•Î¾Î±Î³Ï‰Î³Î® & Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®</div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">Î•Î¹ÏƒÎ±Î³Ï‰Î³Î®</p>
                <input type="file" id="xmlFileInput" accept=".xml" onchange="importFromXML(event)">
                <button class="btn btn-warning" onclick="document.getElementById('xmlFileInput').click()">
                    ğŸ“ XML Import
                </button>
            </div>

            <div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">Î•Î¾Î±Î³Ï‰Î³Î®</p>
                <div class="button-group">
                    <button class="btn btn-email" onclick="openEmailModal()">ğŸ“§ Email</button>
                    <button class="btn btn-success" onclick="exportToXLSX()">ğŸ“Š XLSX</button>
                    <button class="btn btn-success" onclick="exportToCSV()">ğŸ“„ CSV</button>
                    <button class="btn btn-success" onclick="exportToXML()">ğŸ”– XML</button>
                    <button class="btn btn-success" onclick="openPDFModal()">ğŸ“• PDF</button>
                    <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÎŒÎ»Ï‰Î½</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let bomData = [];
        let componentCounter = 1;
        let darkMode = true;
        let persistData = true;
        let fontCache = null;

        async function loadGreekFont() {
            if (fontCache) return fontCache;
            
            try {
                const response = await fetch('https://cdn.jsdelivr.net/npm/dejavu-fonts-ttf@2.37.3/ttf/DejaVuSans.ttf');
                const fontBlob = await response.blob();
                const fontBase64 = await blobToBase64(fontBlob);
                fontCache = fontBase64;
                return fontBase64;
            } catch (error) {
                console.error('Font error:', error);
                return null;
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        window.onload = function() {
            const savedPersist = localStorage.getItem('persistData');
            persistData = savedPersist !== 'false';
            
            if (persistData) {
                const savedData = localStorage.getItem('bomData');
                const savedTheme = localStorage.getItem('theme');
                const savedProject = localStorage.getItem('projectName');
                
                if (savedData) {
                    bomData = JSON.parse(savedData);
                    componentCounter = bomData.length > 0 ? Math.max(...bomData.map(c => c.id)) + 1 : 1;
                    updateTable();
                }

                if (savedProject) {
                    document.getElementById('projectName').value = savedProject;
                }

                if (savedTheme === 'light') {
                    document.body.classList.add('light-mode');
                    darkMode = false;
                    updateThemeButton();
                }
            }

            updatePersistButton();

            document.getElementById('xmlFileInput').addEventListener('click', function() {
                this.value = null;
            });

            document.getElementById('projectName').addEventListener('input', function() {
                if (persistData) {
                    localStorage.setItem('projectName', this.value);
                }
            });
        };

        function togglePersistence() {
            persistData = !persistData;
            localStorage.setItem('persistData', persistData);
            updatePersistButton();
            
            if (persistData) {
                saveData();
                showNotification('ğŸ’¾ Auto-Save ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ');
            } else {
                localStorage.removeItem('bomData');
                localStorage.removeItem('projectName');
                showNotification('ğŸ”“ Auto-Save Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ');
            }
        }

        function updatePersistButton() {
            const btn = document.getElementById('persistToggle');
            const icon = document.getElementById('persistIcon');
            const text = document.getElementById('persistText');
            
            if (persistData) {
                btn.classList.add('active');
                icon.textContent = 'ğŸ’¾';
                text.textContent = 'Auto-Save';
            } else {
                btn.classList.remove('active');
                icon.textContent = 'ğŸ”“';
                text.textContent = 'No Save';
            }
        }

        function toggleTheme() {
            darkMode = !darkMode;
            document.body.classList.toggle('light-mode');
            if (persistData) {
                localStorage.setItem('theme', darkMode ? 'dark' : 'light');
            }
            updateThemeButton();
            showNotification(darkMode ? 'ğŸŒ™ Dark Mode' : 'â˜€ï¸ Light Mode');
        }

        function updateThemeButton() {
            document.getElementById('themeIcon').textContent = darkMode ? 'â˜€ï¸' : 'ğŸŒ™';
            document.getElementById('themeText').textContent = darkMode ? 'Light' : 'Dark';
        }

        function saveData() {
            if (persistData) {
                localStorage.setItem('bomData', JSON.stringify(bomData));
            }
        }

        function addComponent() {
            const designator = document.getElementById('designator').value.trim();
            const value = document.getElementById('value').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const type = document.getElementById('type').value;

            if (!designator || !value || !quantity || !type) {
                alert('âŒ Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î± Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÎ¬ Ï€ÎµÎ´Î¯Î±!');
                return;
            }

            bomData.push({
                id: componentCounter++,
                designator, value, quantity, type,
                package: document.getElementById('package').value.trim(),
                manufacturer: document.getElementById('manufacturer').value.trim(),
                mpn: document.getElementById('mpn').value.trim(),
                supplier: document.getElementById('supplier').value.trim(),
                sku: document.getElementById('sku').value.trim(),
                price: parseFloat(document.getElementById('price').value) || 0,
                description: document.getElementById('description').value.trim()
            });

            saveData();
            updateTable();
            clearForm();
            showNotification('âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ');
        }

        function updateTable() {
            const tbody = document.getElementById('bomTableBody');
            
            if (bomData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="14" class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ components</div>
                        </td>
                    </tr>
                `;
                updateStats();
                return;
            }

            tbody.innerHTML = bomData.map((c, i) => {
                const badgeClass = 'badge-' + c.type.toLowerCase().replace('-', '-');
                return `
                <tr>
                    <td>${i + 1}</td>
                    <td><strong>${c.designator}</strong></td>
                    <td>${c.value}</td>
                    <td>${c.quantity}</td>
                    <td><span class="badge ${badgeClass}">${c.type}</span></td>
                    <td>${c.package || '-'}</td>
                    <td>${c.manufacturer || '-'}</td>
                    <td>${c.mpn || '-'}</td>
                    <td>${c.supplier || '-'}</td>
                    <td>${c.sku || '-'}</td>
                    <td>${c.price.toFixed(3)}â‚¬</td>
                    <td><strong>${(c.price * c.quantity).toFixed(3)}â‚¬</strong></td>
                    <td>${c.description || '-'}</td>
                    <td><button class="btn btn-danger btn-delete" onclick="deleteComponent(${c.id})">ğŸ—‘ï¸</button></td>
                </tr>
            `}).join('');

            updateStats();
        }

        function updateStats() {
            document.getElementById('totalComponents').textContent = bomData.length;
            document.getElementById('totalQuantity').textContent = bomData.reduce((s, c) => s + c.quantity, 0);
            document.getElementById('totalCost').textContent = bomData.reduce((s, c) => s + (c.price * c.quantity), 0).toFixed(2) + 'â‚¬';
        }

        function deleteComponent(id) {
            if (confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® component;')) {
                bomData = bomData.filter(c => c.id !== id);
                saveData();
                updateTable();
                showNotification('ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ');
            }
        }

        function clearAllData() {
            if (bomData.length === 0 && !document.getElementById('projectName').value) {
                return alert('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±!');
            }

            if (confirm('âš ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŸÎ›Î©Î Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (BOM + Project Name);')) {
                bomData = [];
                componentCounter = 1;
                document.getElementById('projectName').value = '';
                
                if (persistData) {
                    localStorage.removeItem('bomData');
                    localStorage.removeItem('projectName');
                }
                
                updateTable();
                showNotification('ğŸ—‘ï¸ ÎŒÎ»Î± Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½');
            }
        }

        function clearForm() {
            ['designator', 'value', 'type', 'package', 'manufacturer', 'mpn', 'supplier', 'sku', 'price', 'description'].forEach(id => {
                const el = document.getElementById(id);
                if (el.type === 'number') el.value = id === 'quantity' ? '1' : '';
                else el.value = '';
            });
            document.getElementById('designator').focus();
        }

        // EMAIL MODAL FUNCTIONS
        function openEmailModal() {
            if (!bomData.length) return alert('âŒ ÎšÎµÎ½Î® Î»Î¯ÏƒÏ„Î±!');
            document.getElementById('emailModal').classList.add('active');
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.remove('active');
        }

        async function confirmEmailSend() {
            const email = document.getElementById('recipientEmail').value.trim();
            const format = document.querySelector('input[name="emailFormat"]:checked').value;

            if (!email) {
                alert('âŒ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ email!');
                return;
            }

            if (!email.includes('@')) {
                alert('âŒ ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ email!');
                return;
            }

            closeEmailModal();
            showNotification('â³ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î±ÏÏ‡ÎµÎ¯Î¿Ï…...');

            try {
                let fileData, fileName, mimeType;
                const projectName = document.getElementById('projectName').value.trim();
                const dateStr = new Date().toISOString().split('T')[0];

                switch(format) {
                    case 'xlsx':
                        const xlsxResult = await generateXLSX();
                        fileData = xlsxResult.data;
                        fileName = projectName ? `BOM_${projectName}_${dateStr}.xlsx` : `BOM_${dateStr}.xlsx`;
                        mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                        break;
                    
                    case 'csv':
                        fileData = generateCSV();
                        fileName = projectName ? `BOM_${projectName}_${dateStr}.csv` : `BOM_${dateStr}.csv`;
                        mimeType = 'text/csv';
                        break;
                    
                    case 'xml':
                        fileData = generateXML();
                        fileName = projectName ? `BOM_${projectName}_${dateStr}.xml` : `BOM_${dateStr}.xml`;
                        mimeType = 'application/xml';
                        break;
                    
                    case 'pdf':
                        const pdfResult = await generatePDFForEmail();
                        fileData = pdfResult.data;
                        fileName = projectName ? `BOM_${projectName}_landscape_${dateStr}.pdf` : `BOM_landscape_${dateStr}.pdf`;
                        mimeType = 'application/pdf';
                        break;
                }

                // Create mailto link Î¼Îµ attachment simulation
                const subject = encodeURIComponent(`BOM Export - ${projectName || 'Project'}`);
                const body = encodeURIComponent(`ÎšÎ±Î»Î·Î¼Î­ÏÎ±,\n\nÎ£Î±Ï‚ ÏƒÏ„Î­Î»Î½Ï‰ Ï„Î¿ BOM Î±ÏÏ‡ÎµÎ¯Î¿ ÏƒÎµ format ${format.toUpperCase()}.\n\nProject: ${projectName || 'N/A'}\nComponents: ${bomData.length}\nÎ£ÏÎ½Î¿Î»Î¿ Î¤ÎµÎ¼Î±Ï‡Î¯Ï‰Î½: ${bomData.reduce((s,c)=>s+c.quantity,0)}\nÎ£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎšÏŒÏƒÏ„Î¿Ï‚: ${bomData.reduce((s,c)=>s+(c.price*c.quantity),0).toFixed(2)}â‚¬\n\nâš ï¸ Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î­Ï‡ÎµÎ¹ ÎºÎ±Ï„Î­Î²ÎµÎ¹ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± ÏƒÏ„Î¿Î½ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î® ÏƒÎ±Ï‚. Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï„Î¿ Ï‰Ï‚ attachment.\n\nÎ•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Ï!`);
                
                // Download Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿
                downloadFile(fileData, fileName, mimeType);
                
                // Î†Î½Î¿Î¹Î³Î¼Î± email client
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
                
                showNotification(`âœ… Î‘ÏÏ‡ÎµÎ¯Î¿ ${format.toUpperCase()} ÎºÎ±Ï„Î­Î²Î·ÎºÎµ! Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï„Î¿ ÏƒÏ„Î¿ email.`);
            } catch (error) {
                console.error('Email error:', error);
                showNotification('âŒ Î£Ï†Î¬Î»Î¼Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï…');
            }
        }

        function downloadFile(data, filename, mimeType) {
            const blob = new Blob([data], {type: mimeType});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        async function generateXLSX() {
            const data = [
                ['#', 'Designator', 'Value', 'Qty', 'Type', 'Package', 'Manufacturer', 'MPN', 'Supplier', 'SKU', 'Price', 'Total', 'Notes'],
                ...bomData.map((c, i) => [i+1, c.designator, c.value, c.quantity, c.type, c.package, c.manufacturer, c.mpn, c.supplier, c.sku, c.price.toFixed(3), (c.price*c.quantity).toFixed(3), c.description]),
                [],
                ['', '', 'Î£Î¥ÎÎŸÎ›Î‘:', bomData.reduce((s,c)=>s+c.quantity,0), '', '', '', '', '', '', '', bomData.reduce((s,c)=>s+(c.price*c.quantity),0).toFixed(2), '']
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch:5},{wch:15},{wch:15},{wch:8},{wch:12},{wch:12},{wch:20},{wch:20},{wch:15},{wch:15},{wch:10},{wch:12},{wch:40}];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'BOM');
            
            return {
                data: XLSX.write(wb, {bookType: 'xlsx', type: 'array'})
            };
        }

        function generateCSV() {
            let csv = '#,Designator,Value,Qty,Type,Package,Manufacturer,MPN,Supplier,SKU,Price,Total,Notes\n';
            bomData.forEach((c, i) => {
                csv += `${i+1},"${c.designator}","${c.value}",${c.quantity},"${c.type}","${c.package}","${c.manufacturer}","${c.mpn}","${c.supplier}","${c.sku}",${c.price.toFixed(3)},${(c.price*c.quantity).toFixed(3)},"${c.description}"\n`;
            });
            csv += `\n,,"Î£Î¥ÎÎŸÎ›Î‘:",${bomData.reduce((s,c)=>s+c.quantity,0)},,,,,,,,${bomData.reduce((s,c)=>s+(c.price*c.quantity),0).toFixed(2)},\n`;
            return '\ufeff' + csv;
        }

        function generateXML() {
            const projectName = document.getElementById('projectName').value.trim();
            
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<BOM>\n  <metadata>\n';
            if (projectName) {
                xml += `    <projectName><![CDATA[${projectName}]]></projectName>\n`;
            }
            xml += `    <date>${new Date().toISOString()}</date>\n`;
            xml += `    <totalComponents>${bomData.length}</totalComponents>\n`;
            xml += `    <totalQuantity>${bomData.reduce((s,c)=>s+c.quantity,0)}</totalQuantity>\n`;
            xml += `    <totalCost>${bomData.reduce((s,c)=>s+(c.price*c.quantity),0).toFixed(2)}</totalCost>\n`;
            xml += '  </metadata>\n  <components>\n';

            bomData.forEach(c => {
                xml += '    <component>\n';
                Object.entries(c).forEach(([k,v]) => {
                    xml += `      <${k}><![CDATA[${v}]]></${k}>\n`;
                });
                xml += '    </component>\n';
            });

            xml += '  </components>\n</BOM>';
            return xml;
        }

        async function generatePDFForEmail() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'mm', 'a4'); // Default landscape Î³Î¹Î± email

            const fontBase64 = await loadGreekFont();
            if (fontBase64) {
                doc.addFileToVFS('DejaVuSans.ttf', fontBase64);
                doc.addFont('DejaVuSans.ttf', 'DejaVuSans', 'normal');
                doc.setFont('DejaVuSans');
            }

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const projectName = document.getElementById('projectName').value.trim();

            doc.setFillColor(240, 242, 245);
            doc.rect(0, 0, pageWidth, projectName ? 42 : 35, 'F');
            
            doc.setFontSize(18);
            doc.setTextColor(15, 23, 42);
            
            if (projectName) {
                const projectUpper = projectName.toUpperCase();
                doc.text(`BILL OF MATERIALS`, pageWidth / 2, 13, {align: 'center'});
                doc.setFontSize(14);
                doc.setTextColor(99, 102, 241);
                doc.text(`PROJECT: ${projectUpper}`, pageWidth / 2, 22, {align: 'center'});
                doc.setTextColor(15, 23, 42);
            } else {
                doc.text('BILL OF MATERIALS', pageWidth / 2, 15, {align: 'center'});
            }
            
            doc.setFontSize(9);
            doc.setTextColor(100, 116, 139);
            const metadataY = projectName ? 29 : 22;
            doc.text(`Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ${new Date().toLocaleDateString('el-GR')}`, pageWidth / 2, metadataY, {align: 'center'});
            doc.text(`Components: ${bomData.length} | Î¤ÎµÎ¼Î¬Ï‡Î¹Î±: ${bomData.reduce((s,c)=>s+c.quantity,0)} | ÎšÏŒÏƒÏ„Î¿Ï‚: ${bomData.reduce((s,c)=>s+(c.price*c.quantity),0).toFixed(2)}â‚¬`, pageWidth / 2, metadataY + 7, {align: 'center'});

            const tableData = bomData.map((c, i) => [
                i + 1, c.designator, c.value, c.quantity, c.type, c.package || '-',
                c.manufacturer || '-', c.mpn || '-', c.supplier || '-', c.sku || '-',
                c.price.toFixed(3) + 'â‚¬', (c.price * c.quantity).toFixed(3) + 'â‚¬', c.description || '-'
            ]);

            tableData.push(['', '', 'Î£Î¥ÎÎŸÎ›Î‘:', bomData.reduce((s,c)=>s+c.quantity,0), '', '', '', '', '', '', '', 
                bomData.reduce((s,c)=>s+(c.price*c.quantity),0).toFixed(2) + 'â‚¬', '']);

            const columnStyles = {
                0: { cellWidth: 9, halign: 'center' },
                1: { cellWidth: 18 },
                2: { cellWidth: 18 },
                3: { cellWidth: 12, halign: 'center', overflow: 'visible' },
                4: { cellWidth: 16, halign: 'center', overflow: 'visible' },
                5: { cellWidth: 15 },
                6: { cellWidth: 29 },
                7: { cellWidth: 21 },
                8: { cellWidth: 17 },
                9: { cellWidth: 17 },
                10: { cellWidth: 18, halign: 'right' },
                11: { cellWidth: 20, halign: 'right', fontStyle: 'bold' },
                12: { cellWidth: 48 }
            };

            let totalTableWidth = 0;
            Object.values(columnStyles).forEach(style => {
                totalTableWidth += style.cellWidth || 0;
            });

            const horizontalMargin = (pageWidth - totalTableWidth) / 2;

            doc.autoTable({
                head: [['#', 'Designator', 'Value', 'Qty', 'Type', 'Pkg', 'Manufacturer', 'MPN', 'Supplier', 'SKU', 'Price', 'Total', 'Notes']],
                body: tableData,
                startY: projectName ? 47 : 40,
                theme: 'striped',
                tableWidth: totalTableWidth,
                margin: { left: horizontalMargin, right: horizontalMargin, bottom: 25 },
                headStyles: {
                    fillColor: [30, 41, 59],
                    textColor: [255, 255, 255],
                    fontSize: 7,
                    fontStyle: 'bold',
                    halign: 'center',
                    font: fontBase64 ? 'DejaVuSans' : 'helvetica'
                },
                bodyStyles: {
                    fontSize: 6.5,
                    font: fontBase64 ? 'DejaVuSans' : 'helvetica',
                    textColor: [15, 23, 42],
                    cellPadding: 2.5,
                    valign: 'middle',
                    overflow: 'linebreak'
                },
                alternateRowStyles: { fillColor: [248, 250, 252] },
                columnStyles: columnStyles
            });

            return {
                data: doc.output('arraybuffer')
            };
        }

        // EXISTING EXPORT FUNCTIONS
        function exportToXLSX() {
            if (!bomData.length) return alert('âŒ ÎšÎµÎ½Î® Î»Î¯ÏƒÏ„Î±!');
            
            const data = [
                ['#', 'Designator', 'Value', 'Qty', 'Type', 'Package', 'Manufacturer', 'MPN', 'Supplier', 'SKU', 'Price', 'Total', 'Notes'],
                ...bomData.map((c, i) => [i+1, c.designator, c.value, c.quantity, c.type, c.package, c.manufacturer, c.mpn, c.supplier, c.sku, c.price.toFixed(3), (c.price*c.quantity).toFixed(3), c.description]),
                [],
                ['', '', 'Î£Î¥ÎÎŸÎ›Î‘:', bomData.reduce((s,c)=>s+c.quantity,0), '', '', '', '', '', '', '', bomData.reduce((s,c)=>s+(c.price*c.quantity),0).toFixed(2), '']
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch:5},{wch:15},{wch:15},{wch:8},{wch:12},{wch:12},{wch:20},{wch:20},{wch:15},{wch:15},{wch:10},{wch:12},{wch:40}];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'BOM');
            
            const projectName = document.getElementById('projectName').value.trim();
            const fileName = projectName ? `BOM_${projectName}_${new Date().toISOString().split('T')[0]}.xlsx` : `BOM_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            showNotification('âœ… XLSX exported');
        }

        function exportToCSV() {
            if (!bomData.length) return alert('âŒ ÎšÎµÎ½Î® Î»Î¯ÏƒÏ„Î±!');
            
            let csv = '#,Designator,Value,Qty,Type,Package,Manufacturer,MPN,Supplier,SKU,Price,Total,Notes\n';
            bomData.forEach((c, i) => {
                csv += `${i+1},"${c.designator}","${c.value}",${c.quantity},"${c.type}","${c.package}","${c.manufacturer}","${c.mpn}","${c.supplier}","${c.sku}",${c.price.toFixed(3)},${(c.price*c.quantity).toFixed(3)},"${c.description}"\n`;
            });
            csv += `\n,,"Î£Î¥ÎÎŸÎ›Î‘:",${bomData.reduce((s,c)=>s+c.quantity,0)},,,,,,,,${bomData.reduce((s,c)=>s+(c.price*c.quantity),0).toFixed(2)},\n`;

            const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            const projectName = document.getElementById('projectName').value.trim();
            link.download = projectName ? `BOM_${projectName}_${new Date().toISOString().split('T')[0]}.csv` : `BOM_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.click();
            showNotification('âœ… CSV exported');
        }

        function exportToXML() {
            if (!bomData.length) return alert('âŒ ÎšÎµÎ½Î® Î»Î¯ÏƒÏ„Î±!');
            
            const xml = generateXML();
            const blob = new Blob([xml], {type: 'application/xml;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            const projectName = document.getElementById('projectName').value.trim();
            link.download = projectName ? `BOM_${projectName}_${new Date().toISOString().split('T')[0]}.xml` : `BOM_${new Date().toISOString().split('T')[0]}.xml`;
            
            link.click();
            showNotification('âœ… XML exported');
        }

        function importFromXML(event) {
            const file = event.target.files[0];
            if (!file) return;

            showNotification('â³ Loading...');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
                    
                    if (xmlDoc.getElementsByTagName("parsererror").length) {
                        throw new Error('Invalid XML');
                    }

                    const projectNameNode = xmlDoc.getElementsByTagName('projectName')[0];
                    if (projectNameNode) {
                        document.getElementById('projectName').value = projectNameNode.textContent;
                        if (persistData) {
                            localStorage.setItem('projectName', projectNameNode.textContent);
                        }
                    }

                    const components = xmlDoc.getElementsByTagName('component');
                    if (!components.length) return alert('âŒ No components!');

                    if (bomData.length && !confirm(`âš ï¸ Replace ${bomData.length} items?`)) return;

                    bomData = [];
                    let maxId = 0;

                    for (let comp of components) {
                        const id = parseInt(comp.getElementsByTagName('id')[0]?.textContent || '0');
                        if (id > maxId) maxId = id;

                        bomData.push({
                            id,
                            designator: comp.getElementsByTagName('designator')[0]?.textContent || '',
                            value: comp.getElementsByTagName('value')[0]?.textContent || '',
                            quantity: parseInt(comp.getElementsByTagName('quantity')[0]?.textContent || '1'),
                            type: comp.getElementsByTagName('type')[0]?.textContent || 'SMD',
                            package: comp.getElementsByTagName('package')[0]?.textContent || '',
                            manufacturer: comp.getElementsByTagName('manufacturer')[0]?.textContent || '',
                            mpn: comp.getElementsByTagName('mpn')[0]?.textContent || '',
                            supplier: comp.getElementsByTagName('supplier')[0]?.textContent || '',
                            sku: comp.getElementsByTagName('sku')[0]?.textContent || '',
                            price: parseFloat(comp.getElementsByTagName('price')[0]?.textContent || '0'),
                            description: comp.getElementsByTagName('description')[0]?.textContent || ''
                        });
                    }

                    componentCounter = maxId + 1;
                    saveData();
                    updateTable();
                    showNotification(`âœ… Loaded ${bomData.length} items`);
                    event.target.value = '';
                } catch (error) {
                    alert('âŒ XML Error: ' + error.message);
                }
            };

            reader.readAsText(file, 'UTF-8');
        }

        function openPDFModal() {
            if (!bomData.length) return alert('âŒ ÎšÎµÎ½Î® Î»Î¯ÏƒÏ„Î±!');
            document.getElementById('pdfModal').classList.add('active');
        }

        function closePDFModal() {
            document.getElementById('pdfModal').classList.remove('active');
        }

        function confirmPDFExport() {
            const orientation = document.querySelector('input[name="orientation"]:checked').value;
            closePDFModal();
            exportToPDF(orientation);
        }

        async function exportToPDF(orientation) {
            showNotification('â³ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF...');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF(orientation, 'mm', 'a4');

                const fontBase64 = await loadGreekFont();
                if (fontBase64) {
                    doc.addFileToVFS('DejaVuSans.ttf', fontBase64);
                    doc.addFont('DejaVuSans.ttf', 'DejaVuSans', 'normal');
                    doc.setFont('DejaVuSans');
                }

                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const projectName = document.getElementById('projectName').value.trim();

                doc.setFillColor(240, 242, 245);
                doc.rect(0, 0, pageWidth, projectName ? 42 : 35, 'F');
                
                doc.setFontSize(18);
                doc.setTextColor(15, 23, 42);
                
                if (projectName) {
                    const projectUpper = projectName.toUpperCase();
                    doc.text(`BILL OF MATERIALS`, pageWidth / 2, 13, {align: 'center'});
                    doc.setFontSize(14);
                    doc.setTextColor(99, 102, 241);
                    doc.text(`PROJECT: ${projectUpper}`, pageWidth / 2, 22, {align: 'center'});
                    doc.setTextColor(15, 23, 42);
                } else {
                    doc.text('BILL OF MATERIALS', pageWidth / 2, 15, {align: 'center'});
                }
                
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                const metadataY = projectName ? 29 : 22;
                doc.text(`Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ${new Date().toLocaleDateString('el-GR')}`, pageWidth / 2, metadataY, {align: 'center'});
                doc.text(`Components: ${bomData.length} | Î¤ÎµÎ¼Î¬Ï‡Î¹Î±: ${bomData.reduce((s,c)=>s+c.quantity,0)} | ÎšÏŒÏƒÏ„Î¿Ï‚: ${bomData.reduce((s,c)=>s+(c.price*c.quantity),0).toFixed(2)}â‚¬`, pageWidth / 2, metadataY + 7, {align: 'center'});

                const tableData = bomData.map((c, i) => [
                    i + 1, c.designator, c.value, c.quantity, c.type, c.package || '-',
                    c.manufacturer || '-', c.mpn || '-', c.supplier || '-', c.sku || '-',
                    c.price.toFixed(3) + 'â‚¬', (c.price * c.quantity).toFixed(3) + 'â‚¬', c.description || '-'
                ]);

                const totalRow = ['', '', 'Î£Î¥ÎÎŸÎ›Î‘:', bomData.reduce((s,c)=>s+c.quantity,0), '', '', '', '', '', '', '', 
                    bomData.reduce((s,c)=>s+(c.price*c.quantity),0).toFixed(2) + 'â‚¬', ''];
                
                tableData.push(totalRow);

                const headers = ['#', 'Designator', 'Value', 'Qty', 'Type', 'Pkg', 'Manufacturer', 'MPN', 'Supplier', 'SKU', 'Price', 'Total', 'Notes'];

                let columnStyles = {};
                
                if (orientation === 'portrait') {
                    columnStyles = {
                        0: { cellWidth: 8, halign: 'center' },
                        1: { cellWidth: 15 },
                        2: { cellWidth: 15 },
                        3: { cellWidth: 10, halign: 'center', overflow: 'visible' },
                        4: { cellWidth: 15, halign: 'center', overflow: 'visible' },
                        5: { cellWidth: 12 },
                        6: { cellWidth: 22 },
                        7: { cellWidth: 17 },
                        8: { cellWidth: 15 },
                        9: { cellWidth: 14 },
                        10: { cellWidth: 15, halign: 'right' },
                        11: { cellWidth: 17, halign: 'right', fontStyle: 'bold' },
                        12: { cellWidth: 27 }
                    };
                } else {
                    columnStyles = {
                        0: { cellWidth: 9, halign: 'center' },
                        1: { cellWidth: 18 },
                        2: { cellWidth: 18 },
                        3: { cellWidth: 12, halign: 'center', overflow: 'visible' },
                        4: { cellWidth: 16, halign: 'center', overflow: 'visible' },
                        5: { cellWidth: 15 },
                        6: { cellWidth: 29 },
                        7: { cellWidth: 21 },
                        8: { cellWidth: 17 },
                        9: { cellWidth: 17 },
                        10: { cellWidth: 18, halign: 'right' },
                        11: { cellWidth: 20, halign: 'right', fontStyle: 'bold' },
                        12: { cellWidth: 48 }
                    };
                }

                let totalTableWidth = 0;
                Object.values(columnStyles).forEach(style => {
                    totalTableWidth += style.cellWidth || 0;
                });

                const horizontalMargin = (pageWidth - totalTableWidth) / 2;
                const startY = projectName ? 47 : 40;

                doc.autoTable({
                    head: [headers],
                    body: tableData,
                    startY: startY,
                    theme: 'striped',
                    tableWidth: totalTableWidth,
                    margin: { 
                        left: horizontalMargin, 
                        right: horizontalMargin, 
                        bottom: 25 
                    },
                    headStyles: {
                        fillColor: [30, 41, 59],
                        textColor: [255, 255, 255],
                        fontSize: orientation === 'landscape' ? 7 : 6,
                        fontStyle: 'bold',
                        halign: 'center',
                        font: fontBase64 ? 'DejaVuSans' : 'helvetica',
                        lineWidth: 0.5,
                        lineColor: [148, 163, 184]
                    },
                    bodyStyles: {
                        fontSize: orientation === 'landscape' ? 6.5 : 5.5,
                        font: fontBase64 ? 'DejaVuSans' : 'helvetica',
                        textColor: [15, 23, 42],
                        cellPadding: orientation === 'landscape' ? 2.5 : 2,
                        valign: 'middle',
                        overflow: 'linebreak'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    },
                    columnStyles: columnStyles,
                    styles: {
                        overflow: 'linebreak',
                        cellWidth: 'wrap',
                        lineColor: [226, 232, 240],
                        lineWidth: 0.1,
                        minCellHeight: orientation === 'landscape' ? 8 : 7
                    },
                    didDrawPage: function(data) {
                        doc.setFontSize(7);
                        doc.setTextColor(148, 163, 184);
                        const pageNum = doc.internal.getCurrentPageInfo().pageNumber;
                        const totalPages = doc.internal.getNumberOfPages();
                        doc.text(`Î£ÎµÎ»Î¯Î´Î± ${pageNum} Î±Ï€ÏŒ ${totalPages}`, pageWidth / 2, pageHeight - 10, {align: 'center'});
                        
                        const footerText = projectName ? projectName : 'BOM Manager Pro';
                        doc.text(footerText, pageWidth / 2, pageHeight - 5, {align: 'center'});
                        
                        doc.setDrawColor(226, 232, 240);
                        doc.setLineWidth(0.5);
                        doc.rect(3, 3, pageWidth - 6, pageHeight - 6);
                    }
                });

                const fileName = projectName ? `BOM_${projectName}_${orientation}_${new Date().toISOString().split('T')[0]}.pdf` : `BOM_${orientation}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                doc.save(fileName);
                showNotification(`âœ… PDF exported successfully!`);
                
            } catch (error) {
                console.error('PDF Error:', error);
                showNotification('âŒ Î£Ï†Î¬Î»Î¼Î± PDF: ' + error.message);
            }
        }

        function showNotification(msg) {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = msg;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 2500);
        }

        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                addComponent();
            }
            if (e.key === 'Escape') {
                const pdfModal = document.getElementById('pdfModal');
                const emailModal = document.getElementById('emailModal');
                
                if (pdfModal.classList.contains('active')) {
                    closePDFModal();
                } else if (emailModal.classList.contains('active')) {
                    closeEmailModal();
                } else {
                    clearForm();
                }
            }
        });
    </script>
</body>
</html>
